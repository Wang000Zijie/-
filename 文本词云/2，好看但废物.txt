# analyzer_v2_1.py
import os
import re
import tkinter as tk
from tkinter import ttk, filedialog, messagebox
from collections import Counter
import threading
import platform
import pandas as pd
from matplotlib import pyplot as plt
from matplotlib.figure import Figure
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
try:
    from wordcloud import WordCloud
    HAS_WORDCLOUD = True
except ImportError:
    HAS_WORDCLOUD = False

# -------------- ä¸»é¢˜é…è‰² --------------
THEMES = {
    "light": dict(bg="#f0f0f0", fg="#333", accent="#4CAF50"),
    "dark": dict(bg="#2e2e2e", fg="#e4e4e4", accent="#26a69a")
}
current_theme = "light"


class ScrollableFrame(ttk.Frame):
    """å¸¦çºµå‘æ»šåŠ¨æ¡çš„ Frameï¼Œç”¨äºå›¾è¡¨åŒº"""
    def __init__(self, parent, *a, **k):
        super().__init__(parent, *a, **k)
        canvas = tk.Canvas(self, highlightthickness=0)
        bar = ttk.Scrollbar(self, orient="vertical", command=canvas.yview)
        self.inner = ttk.Frame(canvas)
        self.inner.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
        canvas.create_window((0, 0), window=self.inner, anchor="nw")
        canvas.configure(yscrollcommand=bar.set)
        canvas.pack(side="left", fill="both", expand=True)
        bar.pack(side="right", fill="y")


class AnalyzerApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Excel è¯è¯­é¢‘ç‡åˆ†æ v2.1")
        self.root.geometry("1000x720")
        self.root.minsize(850, 600)
        self.file_path = None
        self.df = None
        self.word_freq = None
        self.stopwords = {"çš„", "äº†", "åœ¨", "æ˜¯", "æˆ‘", "æœ‰", "å’Œ", "å°±", "ä¸", "äºº"}

        # ä¸»é¢˜åˆ‡æ¢å˜é‡
        self.theme_var = tk.StringVar(value=current_theme)
        self.setup_theme()
        self.build_ui()
        self.root.bind_all("<Control-o>", lambda e: self.open_file())

    # ---------------- ä¸»é¢˜ ----------------
    def setup_theme(self, theme=None):
        global current_theme
        if theme:
            current_theme = theme
        style = ttk.Style(self.root)
        style.theme_use("clam")
        bg, fg, accent = THEMES[current_theme]["bg"], THEMES[current_theme]["fg"], THEMES[current_theme]["accent"]
        style.configure(".", background=bg, foreground=fg)
        style.configure("TButton", background=accent, foreground="white", borderwidth=0, focusthickness=0)
        style.map("TButton", background=[("active", accent)])
        style.configure("TLabelframe.Label", foreground=accent, font=("SimHei", 11, "bold"))
        self.root.configure(bg=bg)

    # ---------------- UI ----------------
    def build_ui(self):
        # é¡¶éƒ¨å·¥å…·æ 
        top = ttk.Frame(self.root)
        top.pack(fill="x", padx=5, pady=2)
        ttk.Button(top, text="ğŸ“ æ‰“å¼€", command=self.open_file).pack(side="left", padx=2)
        ttk.Button(top, text="ğŸ¨ æ·±è‰²", command=self.toggle_theme).pack(side="right", padx=2)

        # ä¸»æ°´å¹³ PanedWindow
        paned = ttk.PanedWindow(self.root, orient="horizontal")
        paned.pack(fill="both", expand=True, padx=5, pady=5)

        # å·¦ä¾§æ§åˆ¶é¢æ¿
        left = ttk.LabelFrame(paned, text="åˆ†æè®¾ç½®", padding=10)
        paned.add(left, weight=1)

        # æ–‡ä»¶è·¯å¾„
        ttk.Label(left, text="æ–‡ä»¶è·¯å¾„").grid(row=0, column=0, sticky="w")
        self.path_var = tk.StringVar()
        ttk.Entry(left, textvariable=self.path_var, width=45).grid(row=0, column=1, columnspan=2, padx=5, pady=3)
        ttk.Button(left, text="æµè§ˆ", command=self.open_file).grid(row=0, column=3, padx=5)

        # åˆ—é€‰æ‹©
        ttk.Label(left, text="é€‰æ‹©åˆ—").grid(row=1, column=0, sticky="w")
        self.col_combo = ttk.Combobox(left, state="readonly", width=30)
        self.col_combo.grid(row=1, column=1, columnspan=2, padx=5, pady=3)

        # æ˜¾ç¤ºè¯æ•°ï¼šæ»‘åŠ¨æ¡ + æ•°å­—è¾“å…¥
        ttk.Label(left, text="æ˜¾ç¤ºè¯æ•°").grid(row=2, column=0, sticky="w")
        self.top_n = tk.IntVar(value=20)
        ttk.Scale(left, from_=5, to=50, orient="horizontal", variable=self.top_n,
                  length=120, command=lambda e: self.top_n.set(int(float(e)))).grid(row=2, column=1, padx=5)
        ttk.Spinbox(left, textvariable=self.top_n, width=4, from_=5, to=50).grid(row=2, column=2, padx=3)

        # åœç”¨è¯
        ttk.Label(left, text="åœç”¨è¯").grid(row=3, column=0, sticky="nw")
        self.stop_entry = tk.Text(left, width=28, height=4, wrap="word")
        self.stop_entry.grid(row=3, column=1, columnspan=2, padx=5, pady=3)
        self.stop_entry.insert("1.0", ",".join(self.stopwords))

        # åˆ†ææŒ‰é’®
        ttk.Button(left, text="ğŸ” å¼€å§‹åˆ†æ", command=self.run_analysis).grid(
            row=4, column=1, pady=10, sticky="w")

        # å³ä¾§ç»“æœåŒº
        right = ttk.LabelFrame(paned, text="åˆ†æç»“æœ", padding=10)
        paned.add(right, weight=3)

        # å›¾è¡¨ç±»å‹åˆ‡æ¢ & å·¥å…·æŒ‰é’®
        ctrl = ttk.Frame(right)
        ctrl.pack(fill="x", pady=3)
        self.chart_type = tk.StringVar(value="æŸ±çŠ¶å›¾")
        for t in ["æŸ±çŠ¶å›¾", "é¥¼çŠ¶å›¾", ("è¯äº‘å›¾" if HAS_WORDCLOUD else None)]:
            if not t:
                continue
            ttk.Radiobutton(ctrl, text=t, variable=self.chart_type, value=t).pack(side="left", padx=5)
        ttk.Button(ctrl, text="ğŸ“‹ å¤åˆ¶é«˜é¢‘è¯", command=self.copy_words).pack(side="right", padx=5)
        ttk.Button(ctrl, text="ğŸ’¾ ä¿å­˜å›¾è¡¨", command=self.save_chart).pack(side="right", padx=5)

        # å¯æ»šåŠ¨å›¾è¡¨å®¹å™¨
        self.scroll = ScrollableFrame(right)
        self.scroll.pack(fill="both", expand=True)
        self.chart_container = self.scroll.inner

        # çŠ¶æ€æ 
        self.status = tk.StringVar(value="å°±ç»ª")
        ttk.Label(self.root, textvariable=self.status, relief="sunken", anchor="w").pack(fill="x", padx=2, pady=2)

    # ---------------- åŠŸèƒ½ ----------------
    def open_file(self):
        path = filedialog.askopenfilename(
            title="é€‰æ‹©æ–‡ä»¶",
            filetypes=[
                ("æ‰€æœ‰æ”¯æŒæ ¼å¼", "*.xlsx *.xls *.txt *.docx"),
                ("Excel", "*.xlsx *.xls"),
                ("æ–‡æœ¬", "*.txt"),
                ("Word", "*.docx")
            ])
        if not path:
            return
        self.path_var.set(path)
        self.file_path = path
        ext = os.path.splitext(path)[1].lower()
        try:
            if ext in {".xlsx", ".xls"}:
                self.df = pd.read_excel(path)
                self.col_combo.config(values=list(self.df.columns))
                self.col_combo.set("")
                self.status.set("Excel å·²åŠ è½½")
            elif ext == ".txt":
                with open(path, encoding="utf-8") as f:
                    self.text_content = f.read()
                self.col_combo.config(values=[])
                self.status.set("æ–‡æœ¬å·²åŠ è½½")
            elif ext == ".docx":
                import docx
                doc = docx.Document(path)
                self.text_content = "\n".join(p.text for p in doc.paragraphs)
                self.col_combo.config(values=[])
                self.status.set("Word å·²åŠ è½½")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", str(e))

    def run_analysis(self):
        threading.Thread(target=self._analyze, daemon=True).start()

    def _analyze(self):
        self.status.set("åˆ†æä¸­...")
        try:
            # å–æ–‡æœ¬
            if self.df is not None:
                col = self.col_combo.get()
                if not col:
                    raise ValueError("è¯·é€‰æ‹©åˆ—")
                text = " ".join(self.df[col].dropna().astype(str))
            else:
                text = self.text_content
            # æ¸…æ´—
            text = re.sub(r"[^\u4e00-\u9fa5a-zA-Z0-9]+", " ", text)
            words = text.split()
            stop = {s.strip() for s in self.stop_entry.get("1.0", "end-1c").split(",") if s.strip()}
            words = [w for w in words if w and w not in stop]
            self.word_freq = Counter(words)
            self.status.set(f"å®Œæˆï¼š{len(words)} è¯ï¼Œ{len(self.word_freq)} ç§")
            self.show_chart()
        except Exception as e:
            messagebox.showerror("é”™è¯¯", str(e))
            self.status.set("åˆ†æå¤±è´¥")

    def show_chart(self):
        if not self.word_freq:
            return
        top = self.top_n.get()
        data = self.word_freq.most_common(top)
        if not data:
            return
        words, freqs = zip(*data)

        # æ¸…ç©ºæ—§å›¾
        for w in self.chart_container.winfo_children():
            w.destroy()

        fig = Figure(figsize=(7, 4.5), dpi=100)
        ax = fig.add_subplot(111)
        ctype = self.chart_type.get()

        if ctype == "æŸ±çŠ¶å›¾":
            ax.bar(words, freqs, color="#4CAF50")
            ax.set_title(f"Top {top} è¯è¯­é¢‘ç‡")
            plt.setp(ax.get_xticklabels(), rotation=45, ha="right")
        elif ctype == "é¥¼çŠ¶å›¾":
            ax.pie(freqs, labels=words, autopct="%1.1f%%", startangle=90)
            ax.axis("equal")
            ax.set_title(f"Top {top} è¯è¯­å æ¯”")
        elif ctype == "è¯äº‘å›¾" and HAS_WORDCLOUD:
            wc = WordCloud(
                font_path="simhei.ttf" if platform.system() == "Windows" else None,
                background_color=THEMES[current_theme]["bg"],
                width=700, height=400
            ).generate_from_frequencies(dict(data))
            ax.imshow(wc, interpolation="bilinear")
            ax.axis("off")
            ax.set_title("è¯äº‘å›¾")

        canvas = FigureCanvasTkAgg(fig, master=self.chart_container)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)
        self.canvas = canvas

    def copy_words(self):
        if not self.word_freq:
            return
        lines = [f"{w}\t{f}" for w, f in self.word_freq.most_common(self.top_n.get())]
        self.root.clipboard_clear()
        self.root.clipboard_append("\n".join(lines))
        self.status.set("é«˜é¢‘è¯å·²å¤åˆ¶")

    def save_chart(self):
        if not hasattr(self, "canvas"):
            return
        file = filedialog.asksaveasfilename(
            defaultextension=".png",
            filetypes=[("PNG", "*.png"), ("JPG", "*.jpg"), ("SVG", "*.svg")])
        if file:
            self.canvas.figure.savefig(file, dpi=300, bbox_inches="tight")
            self.status.set("å›¾è¡¨å·²ä¿å­˜")

    def toggle_theme(self):
        new = "dark" if current_theme == "light" else "light"
        self.setup_theme(new)


if __name__ == "__main__":
    root = tk.Tk()
    AnalyzerApp(root)
    root.mainloop()