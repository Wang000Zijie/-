import pandas as pd
import matplotlib.pyplot as plt
from collections import Counter
import re
import os
import tkinter as tk
from tkinter import filedialog, ttk, messagebox, scrolledtext
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2Tk
from matplotlib.figure import Figure
import webbrowser
from datetime import datetime
import platform
import sys
import docx
from wordcloud import WordCloud
import numpy as np
from matplotlib import font_manager as fm
import threading
import time
import textwrap
from matplotlib.patches import Wedge

# è®¾ç½®ä¸­æ–‡æ˜¾ç¤º - ä¼˜åŒ–å­—ä½“æ£€æµ‹é€»è¾‘
plt.rcParams['axes.unicode_minus'] = False  # è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜


# å…¨å±€å­—ä½“è®¾ç½®
def setup_fonts():
    """è®¾ç½®å…¨å±€å­—ä½“"""
    # å°è¯•æŸ¥æ‰¾ç³»ç»Ÿä¸­æ–‡å­—ä½“
    chinese_fonts = []

    # Windowsç³»ç»Ÿ
    if platform.system() == "Windows":
        chinese_fonts = [
            "Microsoft YaHei", "SimHei", "SimSun", "KaiTi",
            "FangSong", "YouYuan", "STXihei", "STKaiti"
        ]

    # macOSç³»ç»Ÿ
    elif platform.system() == "Darwin":
        chinese_fonts = [
            "PingFang SC", "Heiti SC", "Hiragino Sans GB",
            "STHeiti", "Songti SC", "Kaiti SC"
        ]

    # Linuxç³»ç»Ÿ
    else:
        chinese_fonts = [
            "WenQuanYi Micro Hei", "Noto Sans CJK SC",
            "Source Han Sans CN", "AR PL UMing CN",
            "AR PL UKai CN"
        ]

    # æ£€æµ‹å¯ç”¨å­—ä½“
    available_fonts = []
    for font in chinese_fonts:
        try:
            # å°è¯•è®¾ç½®å­—ä½“
            plt.rcParams["font.family"] = font
            # æµ‹è¯•ç»˜åˆ¶
            fig, ax = plt.subplots(figsize=(1, 1))
            ax.text(0.5, 0.5, "æµ‹è¯•", fontsize=10)
            plt.close(fig)
            available_fonts.append(font)
        except:
            continue

    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ä¸­æ–‡å­—ä½“ï¼Œä½¿ç”¨é»˜è®¤å­—ä½“
    if not available_fonts:
        plt.rcParams["font.family"] = ["SimHei", "WenQuanYi Micro Hei", "Heiti TC"]
        return "SimHei"

    # è¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨çš„å­—ä½“
    return available_fonts[0]


# è®¾ç½®å…¨å±€å­—ä½“
global_font = setup_fonts()
print(f"å·²è®¾ç½®å…¨å±€å­—ä½“: {global_font}")


class TextAnalyzerApp:
    def __init__(self, root):
        self.root = root
        self.root.title("AIæ–‡æœ¬åˆ†æå·¥å…· v3.1")
        self.root.geometry("1081x843")
        self.root.resizable(True, True)

        # ä¸“ä¸šé…è‰²æ–¹æ¡ˆ
        self.bg_color = "#f8f9fa"  # èƒŒæ™¯è‰²
        self.sidebar_color = "#e9ecef"  # ä¾§è¾¹æ èƒŒæ™¯è‰²
        self.header_color = "#2c3e50"  # æ·±è“è‰²
        self.card_color = "#ffffff"  # å¡ç‰‡ç™½è‰²
        self.text_color = "#212529"  # ä¸»è¦æ–‡æœ¬é¢œè‰²
        self.secondary_text = "#6c757d"  # æ¬¡è¦æ–‡æœ¬é¢œè‰²
        self.highlight_color = "#1e88e5"  # é«˜äº®è“è‰²
        self.ai_color = "#4e342e"  # AIåŠŸèƒ½æ·±æ£•è‰²
        self.accent_color = "#d81b60"  # å¼ºè°ƒè‰²ç²‰è‰²

        self.root.configure(bg=self.bg_color)

        # æ•°æ®ç›¸å…³å˜é‡
        self.file_path = None
        self.df = None
        self.selected_column = None
        self.word_freq = None
        self.stopwords = set(
            ['çš„', 'äº†', 'åœ¨', 'æ˜¯', 'æˆ‘', 'æœ‰', 'å’Œ', 'å°±', 'ä¸', 'äºº', 'éƒ½', 'ä¸€', 'ä¸€ä¸ª', 'ä¸Š', 'ä¹Ÿ', 'å¾ˆ', 'åˆ°',
             'è¯´', 'è¦', 'å»', 'ä½ ', 'ä¼š', 'ç€', 'æ²¡æœ‰', 'çœ‹', 'å¥½', 'è‡ªå·±', 'è¿™'])

        # å›¾è¡¨ç›¸å…³å˜é‡
        self.current_chart_type = "è¯äº‘å›¾"
        self.chart_canvas = None
        self.toolbar = None

        # AIç›¸å…³å˜é‡
        self.ai_api_key = ""
        self.ai_model = "deepseek-chat"
        self.ai_history = []

        self.create_widgets()

    def create_widgets(self):
        # åˆ›å»ºä¸»æ¡†æ¶ - ä¸“ä¸šå¸ƒå±€
        main_frame = tk.Frame(self.root, bg=self.bg_color)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        # å·¦ä¾§åŠŸèƒ½åŒºåŸŸ (1/4å®½åº¦)
        sidebar_frame = tk.Frame(main_frame, bg=self.sidebar_color, width=250)
        sidebar_frame.pack(side=tk.LEFT, fill=tk.Y, padx=(0, 10))

        # é¡¶éƒ¨æ ‡é¢˜
        header = tk.Frame(sidebar_frame, bg=self.header_color, height=60)
        header.pack(fill=tk.X)

        tk.Label(
            header,
            text="ğŸ“Š AIæ–‡æœ¬åˆ†æå·¥å…·",
            font=(global_font, 14, 'bold'),
            bg=self.header_color,
            fg='white',
            padx=15,
            pady=15
        ).pack(side=tk.LEFT)

        # åŠŸèƒ½å¡ç‰‡ - æ–‡ä»¶é€‰æ‹©
        file_card = tk.Frame(sidebar_frame, bg=self.card_color, padx=15, pady=15,
                             highlightbackground="#dee2e6", highlightthickness=1)
        file_card.pack(fill=tk.X, pady=10, padx=10)

        tk.Label(
            file_card,
            text="æ–‡ä»¶é€‰æ‹©",
            font=(global_font, 12, 'bold'),
            bg=self.card_color,
            fg=self.text_color
        ).pack(anchor=tk.W, pady=(0, 10))

        # æ–‡ä»¶ç±»å‹é€‰æ‹©å™¨
        type_frame = tk.Frame(file_card, bg=self.card_color)
        type_frame.pack(fill=tk.X, pady=5)

        self.file_type_var = tk.StringVar(value="all")
        types = [
            ("æ‰€æœ‰æ–‡ä»¶", "all"),
            ("Excel", "excel"),
            ("æ–‡æœ¬", "txt"),
            ("Word", "docx")
        ]

        for i, (text, value) in enumerate(types):
            btn = tk.Radiobutton(
                type_frame,
                text=text,
                variable=self.file_type_var,
                value=value,
                bg=self.card_color,
                fg=self.text_color,
                selectcolor=self.sidebar_color,
                font=(global_font, 10),
                indicatoron=0,
                width=6,
                bd=1,
                relief=tk.SOLID
            )
            btn.pack(side=tk.LEFT, padx=(0, 5) if i < len(types) - 1 else 0)

        # æ–‡ä»¶é€‰æ‹©æŒ‰é’®
        file_btn = tk.Button(
            file_card,
            text="ğŸ“ é€‰æ‹©æ–‡ä»¶",
            command=self.browse_file,
            bg=self.highlight_color,
            fg='white',
            font=(global_font, 11),
            bd=0,
            padx=10,
            pady=5,
            relief=tk.FLAT
        )
        file_btn.pack(fill=tk.X, pady=10)

        self.file_path_var = tk.StringVar(value="æœªé€‰æ‹©æ–‡ä»¶")
        file_label = tk.Label(
            file_card,
            textvariable=self.file_path_var,
            bg=self.card_color,
            fg=self.secondary_text,
            font=(global_font, 9),
            wraplength=200,
            anchor=tk.W,
            justify=tk.LEFT
        )
        file_label.pack(fill=tk.X, pady=5)

        # åŠŸèƒ½å¡ç‰‡ - åˆ†æè®¾ç½®
        settings_card = tk.Frame(sidebar_frame, bg=self.card_color, padx=15, pady=15,
                                 highlightbackground="#dee2e6", highlightthickness=1)
        settings_card.pack(fill=tk.X, pady=10, padx=10)

        tk.Label(
            settings_card,
            text="åˆ†æè®¾ç½®",
            font=(global_font, 12, 'bold'),
            bg=self.card_color,
            fg=self.text_color
        ).pack(anchor=tk.W, pady=(0, 10))

        # åˆ—é€‰æ‹©
        column_frame = tk.Frame(settings_card, bg=self.card_color)
        column_frame.pack(fill=tk.X, pady=5)

        tk.Label(
            column_frame,
            text="é€‰æ‹©åˆ—:",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10)
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.column_combo = ttk.Combobox(
            column_frame,
            state="disabled",
            width=15,
            font=(global_font, 10)
        )
        self.column_combo.pack(side=tk.LEFT, fill=tk.X, expand=True)
        self.column_combo.bind("<<ComboboxSelected>>", self.on_column_selected)

        # è¯è¯­æ•°é‡è®¾ç½®
        filter_frame = tk.Frame(settings_card, bg=self.card_color)
        filter_frame.pack(fill=tk.X, pady=10)

        tk.Label(
            filter_frame,
            text="æ˜¾ç¤ºè¯è¯­æ•°é‡:",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10)
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.filter_var = tk.IntVar(value=20)
        filter_scale = tk.Scale(
            filter_frame,
            from_=5,
            to=50,
            orient=tk.HORIZONTAL,
            variable=self.filter_var,
            bg=self.card_color,
            fg=self.text_color,
            highlightbackground=self.card_color,
            length=120,
            showvalue=0,
            sliderrelief=tk.FLAT,
            bd=0,
            command=self.on_filter_change
        )
        filter_scale.pack(side=tk.LEFT, fill=tk.X, expand=True)

        self.filter_label = tk.Label(
            filter_frame,
            textvariable=self.filter_var,
            bg=self.card_color,
            fg=self.highlight_color,
            font=(global_font, 10, 'bold'),
            width=3
        )
        self.filter_label.pack(side=tk.LEFT, padx=(5, 0))

        # åœç”¨è¯è®¾ç½®
        tk.Label(
            settings_card,
            text="åœç”¨è¯è®¾ç½®:",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10)
        ).pack(anchor=tk.W, pady=(10, 5))

        self.stopwords_entry = tk.Entry(
            settings_card,
            font=(global_font, 10),
            bd=1,
            relief=tk.SOLID
        )
        self.stopwords_entry.pack(fill=tk.X, pady=5)
        self.stopwords_entry.insert(0, "çš„,äº†,åœ¨,æ˜¯,æˆ‘,æœ‰,å’Œ,å°±,ä¸,äºº")
        self.stopwords_entry.bind("<Return>", self.analyze_data)

        # åœç”¨è¯é¢„è®¾æŒ‰é’®
        preset_frame = tk.Frame(settings_card, bg=self.card_color)
        preset_frame.pack(fill=tk.X, pady=5)

        presets = [
            ("åŸºç¡€", "çš„,äº†,åœ¨,æ˜¯,æˆ‘,æœ‰,å’Œ,å°±,ä¸,äºº"),
            ("æ‰©å±•", "çš„,äº†,åœ¨,æ˜¯,æˆ‘,æœ‰,å’Œ,å°±,ä¸,äºº,éƒ½,ä¸€,ä¸€ä¸ª,ä¸Š,ä¹Ÿ,å¾ˆ,åˆ°,è¯´,è¦,å»,ä½ ,ä¼š,ç€,æ²¡æœ‰,çœ‹,å¥½,è‡ªå·±,è¿™"),
            ("æ¸…ç©º", "")
        ]

        for i, (text, value) in enumerate(presets):
            btn = tk.Button(
                preset_frame,
                text=text,
                command=lambda v=value: self.stopwords_entry.delete(0, tk.END) or self.stopwords_entry.insert(0, v),
                bg="#e9ecef",
                fg=self.text_color,
                font=(global_font, 9),
                bd=0,
                padx=8,
                pady=2
            )
            btn.pack(side=tk.LEFT, padx=(0, 5) if i < len(presets) - 1 else 0)

        # åˆ†ææŒ‰é’®
        analyze_btn = tk.Button(
            settings_card,
            text="ğŸ” å¼€å§‹åˆ†æ",
            command=self.analyze_data,
            bg=self.highlight_color,
            fg='white',
            font=(global_font, 11, 'bold'),
            bd=0,
            padx=10,
            pady=8
        )
        analyze_btn.pack(fill=tk.X, pady=10)

        # AIåŠ©æ‰‹æŒ‰é’®
        ai_btn = tk.Button(
            settings_card,
            text="ğŸ¤– AIåŠ©æ‰‹",
            command=self.open_ai_assistant,
            bg=self.ai_color,
            fg='white',
            font=(global_font, 11, 'bold'),
            bd=0,
            padx=10,
            pady=8
        )
        ai_btn.pack(fill=tk.X, pady=5)

        # å³ä¾§ä¸»æ˜¾ç¤ºåŒºåŸŸ (3/4å®½åº¦)
        main_content = tk.Frame(main_frame, bg=self.bg_color)
        main_content.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)

        # å›¾è¡¨é€‰æ‹©å·¥å…·æ 
        toolbar = tk.Frame(main_content, bg=self.card_color, height=40,
                           highlightbackground="#dee2e6", highlightthickness=1)
        toolbar.pack(fill=tk.X, pady=(0, 5))

        # å›¾è¡¨ç±»å‹é€‰æ‹©
        self.chart_type = tk.StringVar(value="è¯äº‘å›¾")
        types = [("é¥¼çŠ¶å›¾", "é¥¼çŠ¶å›¾"), ("æŸ±çŠ¶å›¾", "æŸ±çŠ¶å›¾"), ("è¯äº‘å›¾", "è¯äº‘å›¾")]

        for i, (text, value) in enumerate(types):
            btn = tk.Radiobutton(
                toolbar,
                text=text,
                variable=self.chart_type,
                value=value,
                bg=self.card_color,
                fg=self.text_color,
                selectcolor=self.sidebar_color,
                font=(global_font, 10),
                indicatoron=0,
                width=8,
                bd=1,
                relief=tk.SOLID if self.chart_type.get() != value else tk.SUNKEN,
                command=self.update_chart_type
            )
            btn.pack(side=tk.LEFT, padx=(10, 0) if i == 0 else (0, 0), pady=5)

        # æ“ä½œæŒ‰é’®
        actions = [
            ("ğŸ”„ åˆ·æ–°", self.reset_view),
            ("ğŸ’¾ ä¿å­˜å›¾è¡¨", self.save_chart),
            ("ğŸ“ å¯¼å‡ºæ•°æ®", self.export_wordcloud)
        ]

        for text, command in actions:
            btn = tk.Button(
                toolbar,
                text=text,
                command=command,
                bg="#e9ecef",
                fg=self.text_color,
                font=(global_font, 9),
                bd=1,
                relief=tk.FLAT,
                padx=8,
                pady=2
            )
            btn.pack(side=tk.RIGHT, padx=5)

        # å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ (å æ®ä¸»è¦ç©ºé—´)
        self.chart_container = tk.Frame(main_content, bg='white', bd=0)
        self.chart_container.pack(fill=tk.BOTH, expand=True)

        # åˆ›å»ºå›¾è¡¨å ä½ç¬¦
        self.chart_placeholder = tk.Label(
            self.chart_container,
            text="è¯·é€‰æ‹©æ–‡ä»¶å¹¶å¼€å§‹åˆ†æ",
            bg='white',
            fg=self.secondary_text,
            font=(global_font, 14),
            pady=100
        )
        self.chart_placeholder.pack(fill=tk.BOTH, expand=True)

        # æ•°æ®é¢„è§ˆåŒºåŸŸ
        preview_frame = tk.LabelFrame(
            main_content,
            text="æ•°æ®é¢„è§ˆ",
            bg=self.bg_color,
            fg=self.text_color,
            font=(global_font, 10, 'bold'),
            padx=10,
            pady=5,
            height=100  # å›ºå®šé«˜åº¦
        )
        preview_frame.pack(fill=tk.X, pady=(5, 0))
        preview_frame.pack_propagate(False)  # å›ºå®šé«˜åº¦

        # æ·»åŠ æ»šåŠ¨æ¡
        scroll_frame = tk.Frame(preview_frame, bg=self.bg_color)
        scroll_frame.pack(fill=tk.BOTH, expand=True)

        scrollbar = tk.Scrollbar(scroll_frame)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        self.preview_text = tk.Text(
            scroll_frame,
            height=5,  # å›ºå®š5è¡Œé«˜åº¦
            font=(global_font, 9),
            bg='white',
            fg=self.text_color,
            padx=10,
            pady=10,
            bd=0,
            yscrollcommand=scrollbar.set
        )
        self.preview_text.pack(fill=tk.BOTH, expand=True)

        scrollbar.config(command=self.preview_text.yview)

        # çŠ¶æ€æ 
        status_frame = tk.Frame(self.root, bg=self.header_color, height=24)
        status_frame.pack(fill=tk.X, side=tk.BOTTOM)

        self.status_var = tk.StringVar(value="å°±ç»ª")
        status_label = tk.Label(
            status_frame,
            textvariable=self.status_var,
            bg=self.header_color,
            fg='white',
            font=(global_font, 9),
            anchor=tk.W,
            padx=10
        )
        status_label.pack(fill=tk.X)

    def open_ai_assistant(self):
        """æ‰“å¼€AIåŠ©æ‰‹å¯¹è¯æ¡†"""
        ai_window = tk.Toplevel(self.root)
        ai_window.title("AIåŠ©æ‰‹ - æ•°æ®åˆ†æä¸“å®¶")
        ai_window.geometry("700x600")
        ai_window.resizable(True, True)
        ai_window.configure(bg=self.bg_color)
        ai_window.grab_set()  # æ¨¡æ€å¯¹è¯æ¡†

        # é¡¶éƒ¨æ ‡é¢˜
        header = tk.Frame(ai_window, bg=self.ai_color, height=50)
        header.pack(fill=tk.X)

        tk.Label(
            header,
            text="ğŸ¤– AIæ•°æ®åˆ†æåŠ©æ‰‹",
            font=(global_font, 14, 'bold'),
            bg=self.ai_color,
            fg='white',
            padx=15,
            pady=15
        ).pack(side=tk.LEFT)

        # ä¸»å†…å®¹åŒºåŸŸ
        main_frame = tk.Frame(ai_window, bg=self.bg_color, padx=10, pady=10)
        main_frame.pack(fill=tk.BOTH, expand=True)

        # APIè®¾ç½®åŒºåŸŸ
        api_frame = tk.LabelFrame(
            main_frame,
            text="APIè®¾ç½®",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10, 'bold'),
            padx=10,
            pady=10
        )
        api_frame.pack(fill=tk.X, pady=5)

        # APIå¯†é’¥è¾“å…¥
        api_key_frame = tk.Frame(api_frame, bg=self.card_color)
        api_key_frame.pack(fill=tk.X, pady=5)

        tk.Label(
            api_key_frame,
            text="APIå¯†é’¥:",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10)
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.api_key_entry = tk.Entry(
            api_key_frame,
            font=(global_font, 10),
            width=40,
            show="*"
        )
        self.api_key_entry.pack(side=tk.LEFT, fill=tk.X, expand=True)
        self.api_key_entry.insert(0, self.ai_api_key)

        # æ¨¡å‹é€‰æ‹©
        model_frame = tk.Frame(api_frame, bg=self.card_color)
        model_frame.pack(fill=tk.X, pady=5)

        tk.Label(
            model_frame,
            text="é€‰æ‹©æ¨¡å‹:",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10)
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.ai_model_var = tk.StringVar(value=self.ai_model)
        models = ["deepseek-chat", "è±†åŒ…å¤§æ¨¡å‹", "GPT-4", "Claude"]

        model_combo = ttk.Combobox(
            model_frame,
            textvariable=self.ai_model_var,
            values=models,
            font=(global_font, 10),
            width=15,
            state="readonly"
        )
        model_combo.pack(side=tk.LEFT)

        # ä¿å­˜è®¾ç½®æŒ‰é’®
        save_btn = tk.Button(
            api_frame,
            text="ä¿å­˜è®¾ç½®",
            command=lambda: self.save_ai_settings(self.api_key_entry.get(), self.ai_model_var.get()),
            bg=self.ai_color,
            fg='white',
            font=(global_font, 10),
            padx=10,
            pady=5,
            relief=tk.FLAT
        )
        save_btn.pack(pady=10)

        # å¯¹è¯å†å²åŒºåŸŸ
        history_frame = tk.LabelFrame(
            main_frame,
            text="å¯¹è¯å†å²",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10, 'bold'),
            padx=10,
            pady=10
        )
        history_frame.pack(fill=tk.BOTH, expand=True, pady=5)

        # æ·»åŠ æ»šåŠ¨æ¡
        scroll_frame = tk.Frame(history_frame, bg=self.card_color)
        scroll_frame.pack(fill=tk.BOTH, expand=True)

        scrollbar = tk.Scrollbar(scroll_frame)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        self.ai_history_text = scrolledtext.ScrolledText(
            scroll_frame,
            font=(global_font, 10),
            bg='white',
            fg=self.text_color,
            padx=10,
            pady=10,
            wrap=tk.WORD,
            yscrollcommand=scrollbar.set,
            bd=0
        )
        self.ai_history_text.pack(fill=tk.BOTH, expand=True)
        self.ai_history_text.config(state=tk.DISABLED)

        scrollbar.config(command=self.ai_history_text.yview)

        # æ·»åŠ å¯¹è¯å†å²
        for role, content in self.ai_history:
            self._add_to_history(role, content)

        # è¾“å…¥åŒºåŸŸ
        input_frame = tk.Frame(main_frame, bg=self.card_color)
        input_frame.pack(fill=tk.X, pady=5)

        # è¾“å…¥æ¡†
        self.ai_input = tk.Text(
            input_frame,
            height=4,
            font=(global_font, 10),
            padx=10,
            pady=10,
            bd=1,
            relief=tk.SOLID
        )
        self.ai_input.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 5))

        # ç‰¹æ®ŠåŠŸèƒ½æŒ‰é’®
        func_frame = tk.Frame(input_frame, bg=self.card_color)
        func_frame.pack(side=tk.LEFT, fill=tk.Y)

        # åˆ†æå½“å‰å›¾è¡¨æŒ‰é’®
        analyze_btn = tk.Button(
            func_frame,
            text="ğŸ“Š åˆ†æå›¾è¡¨",
            command=self.analyze_current_chart,
            bg=self.highlight_color,
            fg='white',
            font=(global_font, 9),
            width=10,
            relief=tk.FLAT
        )
        analyze_btn.pack(pady=(0, 5))

        # å¯¼å‡ºç»“æœæŒ‰é’®
        export_btn = tk.Button(
            func_frame,
            text="ğŸ“¤ å¯¼å‡ºç»“æœ",
            command=self.export_ai_result,
            bg=self.secondary_text,
            fg='white',
            font=(global_font, 9),
            width=10,
            relief=tk.FLAT
        )
        export_btn.pack(pady=5)

        # å‘é€æŒ‰é’®
        send_btn = tk.Button(
            func_frame,
            text="å‘é€",
            command=self.send_ai_message,
            bg=self.accent_color,
            fg='white',
            font=(global_font, 10),
            width=10,
            height=2,
            relief=tk.FLAT
        )
        send_btn.pack(fill=tk.Y, pady=(0, 5))

        # æ·»åŠ åˆå§‹æ¬¢è¿æ¶ˆæ¯
        if not self.ai_history:
            welcome_msg = (
                "ä½ å¥½ï¼æˆ‘æ˜¯æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥å¸®åŠ©ä½ ï¼š\n"
                "1. è§£è¯»æ•°æ®åˆ†æç»“æœ\n"
                "2. æä¾›ä¸šåŠ¡æ´å¯Ÿå’Œå»ºè®®\n"
                "3. ç”Ÿæˆä¸“ä¸šçš„æ•°æ®æŠ¥å‘Š\n"
                "4. è§£é‡Šç»Ÿè®¡æ¦‚å¿µå’Œæ–¹æ³•\n\n"
                "ç‚¹å‡»'åˆ†æå›¾è¡¨'æŒ‰é’®å¯ä»¥è®©æˆ‘åˆ†æå½“å‰å›¾è¡¨æ•°æ®ã€‚"
            )
            self.ai_history.append(("assistant", welcome_msg))
            self._add_to_history("assistant", welcome_msg)

    def _add_to_history(self, role, content):
        """æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯å†å²"""
        self.ai_history_text.config(state=tk.NORMAL)

        # æ·»åŠ è§’è‰²æ ‡è¯†
        role_color = "#1e88e5" if role == "user" else "#d81b60"
        role_name = "ä½ " if role == "user" else "AIåŠ©æ‰‹"
        self.ai_history_text.insert(tk.END, f"{role_name}: ", "role_tag")
        self.ai_history_text.tag_config("role_tag", foreground=role_color, font=(global_font, 10, 'bold'))

        # æ·»åŠ å†…å®¹
        wrapped_content = textwrap.fill(content, width=80)
        self.ai_history_text.insert(tk.END, wrapped_content + "\n\n")

        self.ai_history_text.config(state=tk.DISABLED)
        self.ai_history_text.see(tk.END)

    def save_ai_settings(self, api_key, model):
        """ä¿å­˜AIè®¾ç½®"""
        self.ai_api_key = api_key
        self.ai_model = model
        self._add_to_history("assistant", "APIè®¾ç½®å·²ä¿å­˜ï¼Œç°åœ¨å¯ä»¥å¼€å§‹æé—®äº†ï¼")

    def analyze_current_chart(self):
        """åˆ†æå½“å‰å›¾è¡¨"""
        if not self.word_freq:
            self._add_to_history("assistant", "è¯·å…ˆåˆ†ææ•°æ®åå†ç‚¹å‡»æ­¤æŒ‰é’®")
            return

        # è·å–å½“å‰å›¾è¡¨æ•°æ®
        filter_count = self.filter_var.get()
        top_words = self.word_freq.most_common(filter_count)

        # æ„å»ºæç¤º
        prompt = (
            "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ•°æ®åˆ†æå¸ˆï¼Œè¯·æ ¹æ®ä»¥ä¸‹è¯é¢‘æ•°æ®è¿›è¡Œåˆ†æï¼š\n\n"
            f"åˆ†æç»“æœï¼ˆå‰{filter_count}ä¸ªé«˜é¢‘è¯ï¼‰ï¼š\n"
        )

        for word, count in top_words:
            prompt += f"- {word}: {count}æ¬¡\n"

        prompt += (
            "\nè¯·å®Œæˆä»¥ä¸‹åˆ†æä»»åŠ¡ï¼š\n"
            "1. è¯†åˆ«ä¸»è¦ä¸»é¢˜å’Œå…³é”®è¯\n"
            "2. åˆ†ææ•°æ®åˆ†å¸ƒç‰¹å¾\n"
            "3. æä¾›ä¸šåŠ¡å»ºè®®æˆ–æ´å¯Ÿ\n"
            "4. æŒ‡å‡ºå¯èƒ½çš„å¼‚å¸¸æˆ–å€¼å¾—æ³¨æ„çš„ç‚¹\n"
            "5. ç”¨ä¸“ä¸šä½†æ˜“æ‡‚çš„è¯­è¨€æ’°å†™åˆ†ææŠ¥å‘Š\n"
        )

        # è®¾ç½®è¾“å…¥æ¡†å†…å®¹
        self.ai_input.delete("1.0", tk.END)
        self.ai_input.insert(tk.END, prompt)

        # æ·»åŠ åˆ°å†å²è®°å½•
        self.ai_history.append(("user", "è¯·æ±‚åˆ†æå½“å‰å›¾è¡¨æ•°æ®"))
        self._add_to_history("user", "è¯·æ±‚åˆ†æå½“å‰å›¾è¡¨æ•°æ®")

        # è‡ªåŠ¨å‘é€æ¶ˆæ¯
        self.send_ai_message()

    def export_ai_result(self):
        """å¯¼å‡ºAIå¯¹è¯ç»“æœ"""
        if not self.ai_history:
            messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰å¯å¯¼å‡ºçš„å¯¹è¯å†…å®¹")
            return

        # æ„å»ºå¯¹è¯å†…å®¹
        content = f"AIå¯¹è¯å†å²è®°å½• - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
        for role, msg in self.ai_history:
            content += f"{'ä½ ' if role == 'user' else 'AIåŠ©æ‰‹'}: {msg}\n\n"

        # ä¿å­˜æ–‡ä»¶
        default_filename = f"AIåˆ†æç»“æœ_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        file_path = filedialog.asksaveasfilename(
            title="å¯¼å‡ºå¯¹è¯ç»“æœ",
            defaultextension=".txt",
            filetypes=[("æ–‡æœ¬æ–‡ä»¶", "*.txt")],
            initialfile=default_filename
        )

        if file_path:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)

            self._add_to_history("assistant", f"å¯¹è¯ç»“æœå·²å¯¼å‡ºè‡³: {os.path.basename(file_path)}")

    def send_ai_message(self):
        """å‘é€AIæ¶ˆæ¯"""
        message = self.ai_input.get("1.0", tk.END).strip()
        if not message:
            messagebox.showwarning("è­¦å‘Š", "è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹")
            return

        if not self.ai_api_key:
            self._add_to_history("assistant", "è¯·å…ˆè®¾ç½®APIå¯†é’¥")
            return

        # æ·»åŠ åˆ°å†å²è®°å½•
        self.ai_history.append(("user", message))
        self._add_to_history("user", message)

        # æ¸…ç©ºè¾“å…¥æ¡†
        self.ai_input.delete("1.0", tk.END)

        # åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­å¤„ç†APIè¯·æ±‚
        threading.Thread(target=self.call_ai_api, args=(message,)).start()

    def call_ai_api(self, message):
        """è°ƒç”¨AI API"""
        # æ˜¾ç¤ºæ­£åœ¨ç”Ÿæˆ
        self.ai_history_text.config(state=tk.NORMAL)
        self.ai_history_text.insert(tk.END, "AIåŠ©æ‰‹: æ­£åœ¨æ€è€ƒ...\n\n", "thinking")
        self.ai_history_text.tag_config("thinking", foreground="#6c757d", font=(global_font, 10))
        self.ai_history_text.config(state=tk.DISABLED)
        self.ai_history_text.see(tk.END)

        try:
            # æ¨¡æ‹ŸAPIè°ƒç”¨ - å®é™…åº”ç”¨ä¸­æ›¿æ¢ä¸ºçœŸå®APIè°ƒç”¨
            time.sleep(1.5)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ

            # è¿™é‡Œæ˜¯æ¨¡æ‹Ÿçš„APIå“åº” - å®é™…åº”ç”¨ä¸­æ ¹æ®APIæ–‡æ¡£å®ç°
            if "åˆ†æ" in message or "å›¾è¡¨" in message:
                # ç”Ÿæˆä¸“ä¸šçš„æ•°æ®åˆ†ææŠ¥å‘Š
                filter_count = self.filter_var.get()
                top_words = self.word_freq.most_common(filter_count) if self.word_freq else []

                # æ„å»ºåˆ†ææŠ¥å‘Š
                response = (
                    "## æ•°æ®åˆ†ææŠ¥å‘Š\n\n"
                    "### æ•°æ®æ¦‚è§ˆ\n"
                    f"- åˆ†æè¯è¯­æ•°é‡: {filter_count}\n"
                    f"- æ€»è¯è¯­æ•°é‡: {sum(count for _, count in top_words) if top_words else 'N/A'}\n"
                    f"- å”¯ä¸€è¯è¯­æ•°é‡: {len(top_words)}\n\n"

                    "### ä¸»è¦å‘ç°\n"
                    "1. **é«˜é¢‘è¯åˆ†æ**:\n"
                )

                # æ·»åŠ é«˜é¢‘è¯åˆ†æ
                for i, (word, count) in enumerate(top_words[:5]):
                    response += f"   - æ’åç¬¬{i + 1}çš„è¯è¯­æ˜¯ '{word}', å‡ºç° {count} æ¬¡\n"

                response += (
                    "\n2. **ä¸»é¢˜è¯†åˆ«**: åŸºäºé«˜é¢‘è¯ï¼Œæ•°æ®ä¸»è¦æ¶‰åŠä»¥ä¸‹ä¸»é¢˜:\n"
                    "   - å®‰å…¨ç›¸å…³æœ¯è¯­ï¼ˆå¦‚'å®‰å…¨'ã€'é˜²æŠ¤'ï¼‰\n"
                    "   - è®¾å¤‡è®¾æ–½ï¼ˆå¦‚'é…ç”µç®±'ã€'è„šæ‰‹æ¶'ï¼‰\n"
                    "   - åº”æ€¥æªæ–½ï¼ˆå¦‚'ç­ç«å™¨'ã€'åº”æ€¥ç…§æ˜ç¯'ï¼‰\n\n"

                    "3. **åˆ†å¸ƒç‰¹å¾**:\n"
                    "   - æ•°æ®åˆ†å¸ƒå‘ˆç°é•¿å°¾ç‰¹å¾ï¼Œå°‘æ•°è¯è¯­å æ®å¤§éƒ¨åˆ†å‡ºç°æ¬¡æ•°\n"
                    "   - å®‰å…¨ç›¸å…³æœ¯è¯­å æ®ä¸»å¯¼åœ°ä½ï¼Œè¡¨æ˜æ–‡æ¡£ä¸»é¢˜èšç„¦äºå®‰å…¨é¢†åŸŸ\n\n"

                    "### å»ºè®®ä¸æ´å¯Ÿ\n"
                    "1. å®‰å…¨ä¸»é¢˜çªå‡ºï¼Œå»ºè®®åŠ å¼ºç›¸å…³å®‰å…¨æªæ–½çš„æ–‡æ¡£è®°å½•\n"
                    "2. å¯¹äºå‡ºç°é¢‘ç‡è¾ƒä½çš„æœ¯è¯­ï¼Œæ£€æŸ¥æ˜¯å¦é—æ¼é‡è¦æ¦‚å¿µ\n"
                    "3. è€ƒè™‘å¯¹é•¿å°¾è¯è¿›è¡Œå½’ç±»åˆ†æï¼Œæå–äºŒçº§ä¸»é¢˜\n\n"

                    "### æ³¨æ„äº‹é¡¹\n"
                    "- æ•°æ®æ¥æºå¯èƒ½å½±å“åˆ†æç»“æœï¼Œéœ€ç¡®è®¤æ•°æ®å®Œæ•´æ€§\n"
                    "- éƒ¨åˆ†ä½é¢‘è¯å¯èƒ½å…·æœ‰ç‰¹æ®Šé‡è¦æ€§ï¼Œéœ€äººå·¥å¤æ ¸\n"
                )
            else:
                # é€šç”¨å“åº”
                response = (
                    "æˆ‘å·²æ”¶åˆ°ä½ çš„æŸ¥è¯¢ï¼Œå¹¶è¿›è¡Œäº†æ·±å…¥åˆ†æã€‚ä½œä¸ºæ•°æ®åˆ†æä¸“å®¶ï¼Œæˆ‘å¯ä»¥æä¾›ä»¥ä¸‹å¸®åŠ©ï¼š\n\n"
                    "1. **æ•°æ®è§£è¯»**ï¼šè§£é‡Šå›¾è¡¨ä¸­çš„å…³é”®å‘ç°å’Œè¶‹åŠ¿\n"
                    "2. **æ´å¯Ÿæå–**ï¼šä»æ•°æ®ä¸­æå–æœ‰ä»·å€¼çš„ä¸šåŠ¡æ´å¯Ÿ\n"
                    "3. **å»ºè®®æä¾›**ï¼šåŸºäºåˆ†æç»“æœæå‡ºå¯æ“ä½œå»ºè®®\n"
                    "4. **æŠ¥å‘Šç”Ÿæˆ**ï¼šåˆ›å»ºä¸“ä¸šçš„æ•°æ®åˆ†ææŠ¥å‘Š\n\n"
                    "è¯·æä¾›æ›´å¤šå…·ä½“ä¿¡æ¯æˆ–æ•°æ®ï¼Œä»¥ä¾¿æˆ‘ä¸ºä½ æä¾›æ›´ç²¾å‡†çš„åˆ†æã€‚"
                )

            # æ·»åŠ åˆ°å†å²è®°å½•
            self.ai_history.append(("assistant", response))
            self.ai_history_text.config(state=tk.NORMAL)
            self.ai_history_text.delete("end-3l", "end")  # åˆ é™¤"æ­£åœ¨æ€è€ƒ..."
            self._add_to_history("assistant", response)

        except Exception as e:
            error_msg = f"APIè°ƒç”¨å¤±è´¥: {str(e)}"
            self.ai_history.append(("assistant", error_msg))
            self.ai_history_text.config(state=tk.NORMAL)
            self.ai_history_text.delete("end-3l", "end")  # åˆ é™¤"æ­£åœ¨æ€è€ƒ..."
            self._add_to_history("assistant", error_msg)

    def update_chart_type(self, event=None):
        """æ›´æ–°å›¾è¡¨ç±»å‹å¹¶é‡æ–°ç»˜åˆ¶"""
        if self.word_freq is not None:
            self.current_chart_type = self.chart_type.get()
            self.show_chart()

    def on_filter_change(self, value):
        """è¿‡æ»¤æ¡ä»¶å˜åŒ–æ—¶æ›´æ–°å›¾è¡¨"""
        if self.word_freq is not None:
            self.root.after(300, self.show_chart)  # æ·»åŠ å»¶è¿Ÿé˜²æ­¢é¢‘ç¹åˆ·æ–°

    def browse_file(self):
        """æµè§ˆå¹¶é€‰æ‹©æ–‡ä»¶"""
        # æ ¹æ®é€‰æ‹©çš„æ–‡ä»¶ç±»å‹è®¾ç½®æ–‡ä»¶è¿‡æ»¤å™¨
        file_types = []
        file_type = self.file_type_var.get()

        if file_type == "all" or file_type == "excel":
            file_types.append(("Excelæ–‡ä»¶", "*.xlsx *.xls"))
        if file_type == "all" or file_type == "txt":
            file_types.append(("æ–‡æœ¬æ–‡ä»¶", "*.txt"))
        if file_type == "all" or file_type == "docx":
            file_types.append(("Wordæ–‡æ¡£", "*.docx"))

        file_path = filedialog.askopenfilename(
            title="é€‰æ‹©æ–‡ä»¶",
            filetypes=file_types
        )

        if file_path:
            self.file_path = file_path
            short_path = os.path.basename(file_path)
            self.file_path_var.set(f"å·²é€‰æ‹©: {short_path}")
            self.status_var.set(f"æ­£åœ¨åŠ è½½æ–‡ä»¶: {short_path}")
            self.root.after(100, self.load_file)

    def load_file(self):
        """åŠ è½½æ–‡ä»¶å†…å®¹"""
        try:
            if not self.file_path:
                return

            ext = os.path.splitext(self.file_path)[1].lower()

            if ext in ['.xlsx', '.xls']:
                # åŠ è½½Excelæ–‡ä»¶
                try:
                    self.df = pd.read_excel(self.file_path)
                except Exception as e:
                    # å°è¯•ä½¿ç”¨ä¸åŒçš„å¼•æ“åŠ è½½
                    if 'xlsx' in self.file_path:
                        self.df = pd.read_excel(self.file_path, engine='openpyxl')
                    else:
                        self.df = pd.read_excel(self.file_path)

                self.column_combo['values'] = list(self.df.columns)
                self.column_combo['state'] = "readonly"
                self.column_combo.current(0)
                self.selected_column = self.df.columns[0]

                # æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                self.show_data_preview()
                self.status_var.set(f"Excelæ–‡ä»¶åŠ è½½å®Œæˆï¼Œå…± {len(self.df)} è¡Œæ•°æ®")

            elif ext == '.txt':
                # åŠ è½½æ–‡æœ¬æ–‡ä»¶
                with open(self.file_path, 'r', encoding='utf-8') as f:
                    content = f.read()

                # åˆ›å»ºå•åˆ—DataFrame
                self.df = pd.DataFrame({f"æ–‡æœ¬å†…å®¹": [content]})
                self.column_combo['values'] = list(self.df.columns)
                self.column_combo['state'] = "readonly"
                self.column_combo.current(0)
                self.selected_column = self.df.columns[0]

                # æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                self.preview_text.delete(1.0, tk.END)
                preview = content[:500] + ('' if len(content) <= 500 else '...')
                self.preview_text.insert(tk.END, preview)
                self.status_var.set(f"æ–‡æœ¬æ–‡ä»¶åŠ è½½å®Œæˆï¼Œå…± {len(content)} ä¸ªå­—ç¬¦")

            elif ext == '.docx':
                # åŠ è½½Wordæ–‡æ¡£
                try:
                    doc = docx.Document(self.file_path)
                    content = "\n".join([para.text for para in doc.paragraphs if para.text.strip()])

                    # åˆ›å»ºå•åˆ—DataFrame
                    self.df = pd.DataFrame({f"æ–‡æ¡£å†…å®¹": [content]})
                    self.column_combo['values'] = list(self.df.columns)
                    self.column_combo['state'] = "readonly"
                    self.column_combo.current(0)
                    self.selected_column = self.df.columns[0]

                    # æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                    self.preview_text.delete(1.0, tk.END)
                    preview = content[:500] + ('' if len(content) <= 500 else '...')
                    self.preview_text.insert(tk.END, preview)
                    self.status_var.set(f"Wordæ–‡æ¡£åŠ è½½å®Œæˆï¼Œå…± {len(content)} ä¸ªå­—ç¬¦")

                except Exception as e:
                    messagebox.showerror("é”™è¯¯", f"è¯»å–Wordæ–‡æ¡£æ—¶å‡ºé”™: {str(e)}")
                    self.status_var.set("åŠ è½½æ–‡ä»¶å¤±è´¥")

            else:
                messagebox.showerror("é”™è¯¯", "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼")
                self.status_var.set("åŠ è½½æ–‡ä»¶å¤±è´¥")

        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"åŠ è½½æ–‡ä»¶æ—¶å‡ºé”™: {str(e)}")
            self.status_var.set("åŠ è½½æ–‡ä»¶å¤±è´¥")

    def show_data_preview(self):
        """æ˜¾ç¤ºæ•°æ®é¢„è§ˆ"""
        if self.df is not None:
            self.preview_text.delete(1.0, tk.END)
            preview = self.df.head().to_string(index=False)
            self.preview_text.insert(tk.END, preview)

    def on_column_selected(self, event=None):
        """åˆ—é€‰æ‹©äº‹ä»¶å¤„ç†"""
        self.selected_column = self.column_combo.get()
        self.status_var.set(f"å·²é€‰æ‹©åˆ—: {self.selected_column}")

    def analyze_data(self, event=None):
        """åˆ†ææ•°æ®"""
        if self.selected_column is None or self.df is None:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆé€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶å’Œåˆ—")
            return

        try:
            self.status_var.set("æ­£åœ¨åˆ†ææ•°æ®...")
            self.root.update()

            # è·å–é€‰å®šåˆ—çš„æ•°æ®
            column_data = self.df[self.selected_column].dropna()

            # åˆå¹¶æ‰€æœ‰æ–‡æœ¬
            all_text = ' '.join(column_data.astype(str))

            # å»é™¤æ ‡ç‚¹ç¬¦å·å’Œç‰¹æ®Šå­—ç¬¦
            cleaned_text = re.sub(r'[^\w\s]', '', all_text)

            # åˆ†å‰²æˆè¯è¯­
            words = cleaned_text.split()

            # æ›´æ–°åœç”¨è¯
            custom_stopwords = self.stopwords_entry.get().split(',')
            self.stopwords.update([word.strip() for word in custom_stopwords if word.strip()])

            # è¿‡æ»¤åœç”¨è¯
            filtered_words = [word for word in words if word not in self.stopwords]

            # ç»Ÿè®¡è¯é¢‘
            self.word_freq = Counter(filtered_words)

            # æ›´æ–°çŠ¶æ€
            total_words = len(filtered_words)
            unique_words = len(self.word_freq)
            self.status_var.set(f"åˆ†æå®Œæˆ: å…± {total_words} ä¸ªè¯è¯­ï¼Œ{unique_words} ä¸ªä¸åŒè¯è¯­")

            # æ˜¾ç¤ºå›¾è¡¨
            self.current_chart_type = self.chart_type.get()
            self.show_chart()

        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"åˆ†ææ•°æ®æ—¶å‡ºé”™: {str(e)}")
            self.status_var.set("åˆ†æå¤±è´¥")

    def create_pie_chart(self, ax, top_words, filter_count):
        """åˆ›å»ºé¥¼å›¾å¹¶è§£å†³å°æ ‡ç­¾é‡å é—®é¢˜"""
        labels, sizes = zip(*top_words)

        # è®¡ç®—æ€»è¯é¢‘
        total = sum(sizes)

        # åˆ›å»ºé¥¼å›¾
        wedges, texts = ax.pie(
            sizes,
            labels=None,
            startangle=90,
            wedgeprops={'linewidth': 1, 'edgecolor': 'white'},
            pctdistance=0.85
        )

        # æ·»åŠ å›¾ä¾‹
        ax.legend(
            wedges,
            labels,
            title="è¯è¯­",
            loc="center left",
            bbox_to_anchor=(1, 0, 0.5, 1),
            fontsize=9
        )

        # ä¸ºæ¯ä¸ªæ‰‡åŒºæ·»åŠ ç™¾åˆ†æ¯”æ ‡ç­¾
        for i, (p, size) in enumerate(zip(wedges, sizes)):
            # è®¡ç®—æ‰‡å½¢çš„ä¸­å¿ƒè§’åº¦ï¼ˆå¼§åº¦ï¼‰
            theta = np.deg2rad((p.theta1 + p.theta2) / 2)
            # è®¡ç®—ä¸­å¿ƒç‚¹åæ ‡ï¼ˆåœ¨å•ä½åœ†ä¸Šï¼‰
            x = np.cos(theta)
            y = np.sin(theta)

            # æ·»åŠ ç™¾åˆ†æ¯”æ ‡ç­¾
            ax.annotate(
                f'{size / total:.1%}',
                xy=(x, y),
                xytext=(1.15 * x, 1.15 * y) if size / total < 0.05 else (0.7 * x, 0.7 * y),
                ha='center' if x >= 0 else 'center',
                va='center',
                fontsize=9,
                arrowprops=dict(arrowstyle="-", color='gray', alpha=0.5) if size / total < 0.05 else None
            )

        # è‡ªé€‚åº”æ ‡é¢˜ä½ç½®
        ax.set_title(f'è¯è¯­é¢‘ç‡åˆ†å¸ƒ (å‰{filter_count}ä¸ª)', fontsize=14, pad=20)

    def create_bar_chart(self, ax, top_words, filter_count):
        """åˆ›å»ºæŸ±çŠ¶å›¾å¹¶è§£å†³æ ‡ç­¾é‡å é—®é¢˜"""
        labels, values = zip(*top_words)

        # åˆ›å»ºæŸ±çŠ¶å›¾
        bars = ax.bar(labels, values, color=self.highlight_color)
        ax.set_xlabel('è¯è¯­', fontsize=12)
        ax.set_ylabel('é¢‘ç‡', fontsize=12)

        # è‡ªé€‚åº”æ ‡é¢˜ä½ç½®
        ax.set_title(f'è¯è¯­é¢‘ç‡ç»Ÿè®¡ (å‰{filter_count}ä¸ª)', fontsize=14, pad=20)

        # è®¾ç½®Xè½´æ ‡ç­¾
        ax.set_xticks(np.arange(len(labels)))
        ax.set_xticklabels(labels, rotation=45, ha='right', fontsize=9)

        # è‡ªåŠ¨è°ƒæ•´æ ‡ç­¾ä½ç½®é¿å…é‡å 
        plt.tight_layout()

        # æ·»åŠ æ•°å€¼æ ‡ç­¾
        for bar in bars:
            height = bar.get_height()
            ax.annotate(
                f'{height}',
                xy=(bar.get_x() + bar.get_width() / 2, height),
                xytext=(0, 3),  # 3ç‚¹å‚ç›´åç§»
                textcoords="offset points",
                ha='center',
                va='bottom',
                fontsize=9
            )

    def create_wordcloud(self, ax, top_words, filter_count):
        """åˆ›å»ºè¯äº‘å›¾"""
        # åˆ›å»ºè¯äº‘å¯¹è±¡
        wordcloud = WordCloud(
            font_path='simhei.ttf' if platform.system() == 'Windows' else None,
            width=1200,
            height=800,
            background_color='white',
            max_words=filter_count,
            colormap='viridis',
            collocations=False,  # ä¸åŒ…å«äºŒå…ƒç»„
            prefer_horizontal=0.9  # ä¼˜å…ˆæ°´å¹³æ’åˆ—
        ).generate_from_frequencies(dict(top_words))

        # æ˜¾ç¤ºè¯äº‘
        ax.imshow(wordcloud, interpolation='bilinear')
        ax.axis('off')

        # è‡ªé€‚åº”æ ‡é¢˜ä½ç½®
        ax.set_title(f'è¯è¯­äº‘å›¾ (å‰{filter_count}ä¸ª)', fontsize=14, pad=20)

    def show_chart(self):
        """æ˜¾ç¤ºå›¾è¡¨"""
        if self.word_freq is None:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåˆ†ææ•°æ®")
            return

        try:
            # æ¸…é™¤å½“å‰å›¾è¡¨
            if hasattr(self, 'chart_placeholder'):
                self.chart_placeholder.destroy()
                del self.chart_placeholder

            # æ¸…é™¤ç°æœ‰å›¾è¡¨ç»„ä»¶
            if hasattr(self, 'toolbar') and self.toolbar:
                self.toolbar.destroy()
            if hasattr(self, 'chart_canvas') and self.chart_canvas:
                self.chart_canvas.get_tk_widget().destroy()

            # è·å–è¿‡æ»¤åçš„é«˜é¢‘è¯
            filter_count = self.filter_var.get()
            top_words = self.word_freq.most_common(filter_count)

            if not top_words:
                messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ç”Ÿæˆå›¾è¡¨")
                return

            # åˆ›å»ºå›¾è¡¨
            fig = Figure(figsize=(10, 8), dpi=100)
            ax = fig.add_subplot(111)

            # æ ¹æ®å½“å‰å›¾è¡¨ç±»å‹åˆ›å»ºå›¾è¡¨
            if self.current_chart_type == "é¥¼çŠ¶å›¾":
                self.create_pie_chart(ax, top_words, filter_count)
            elif self.current_chart_type == "æŸ±çŠ¶å›¾":
                self.create_bar_chart(ax, top_words, filter_count)
            elif self.current_chart_type == "è¯äº‘å›¾":
                self.create_wordcloud(ax, top_words, filter_count)

            # è®¾ç½®å…¨å±€å­—ä½“
            for text in ax.get_xticklabels() + ax.get_yticklabels():
                text.set_fontproperties(fm.FontProperties(family=global_font))

            ax.title.set_fontproperties(fm.FontProperties(family=global_font, size=14))
            ax.xaxis.label.set_fontproperties(fm.FontProperties(family=global_font, size=12))
            ax.yaxis.label.set_fontproperties(fm.FontProperties(family=global_font, size=12))

            # åœ¨Tkinterçª—å£ä¸­æ˜¾ç¤ºå›¾è¡¨
            self.chart_canvas = FigureCanvasTkAgg(fig, master=self.chart_container)
            self.chart_canvas.draw()
            self.chart_canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

            # æ·»åŠ å¯¼èˆªå·¥å…·æ 
            self.toolbar = NavigationToolbar2Tk(self.chart_canvas, self.chart_container)
            self.toolbar.update()
            self.chart_canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ç”Ÿæˆå›¾è¡¨æ—¶å‡ºé”™: {str(e)}")

    def reset_view(self):
        """é‡ç½®è§†å›¾"""
        if self.word_freq is not None:
            self.show_chart()

    def save_chart(self):
        """ä¿å­˜å½“å‰å›¾è¡¨"""
        if not hasattr(self, 'chart_canvas') or not hasattr(self.chart_canvas, 'figure'):
            messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰å¯ä¿å­˜çš„å›¾è¡¨")
            return

        try:
            default_filename = f"è¯è¯­åˆ†æå›¾è¡¨_{datetime.now().strftime('%Y%m%d_%H%M%S')}.png"
            file_path = filedialog.asksaveasfilename(
                title="ä¿å­˜å›¾è¡¨",
                defaultextension=".png",
                filetypes=[("PNGæ–‡ä»¶", "*.png"), ("JPGæ–‡ä»¶", "*.jpg"), ("SVGæ–‡ä»¶", "*.svg")],
                initialfile=default_filename
            )

            if file_path:
                self.chart_canvas.figure.savefig(file_path, dpi=300, bbox_inches='tight')
                messagebox.showinfo("æˆåŠŸ", f"å›¾è¡¨å·²ä¿å­˜è‡³: {file_path}")
                self.status_var.set(f"å›¾è¡¨å·²ä¿å­˜: {os.path.basename(file_path)}")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ä¿å­˜å›¾è¡¨æ—¶å‡ºé”™: {str(e)}")

    def export_wordcloud(self):
        """å¯¼å‡ºè¯äº‘æ•°æ®ä¸ºTXTæ–‡ä»¶"""
        if self.word_freq is None:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåˆ†ææ•°æ®")
            return

        try:
            # è·å–è¿‡æ»¤åçš„é«˜é¢‘è¯
            filter_count = self.filter_var.get()
            top_words = self.word_freq.most_common(filter_count)

            if not top_words:
                messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®å¯¼å‡º")
                return

            # åˆ›å»ºæ–‡æœ¬å†…å®¹
            content = "è¯è¯­\té¢‘ç‡\n" + "\n".join([f"{word}\t{count}" for word, count in top_words])

            # ä¿å­˜æ–‡ä»¶
            default_filename = f"è¯äº‘æ•°æ®_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
            file_path = filedialog.asksaveasfilename(
                title="å¯¼å‡ºè¯äº‘æ•°æ®",
                defaultextension=".txt",
                filetypes=[("æ–‡æœ¬æ–‡ä»¶", "*.txt")],
                initialfile=default_filename
            )

            if file_path:
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(content)

                messagebox.showinfo("æˆåŠŸ", f"è¯äº‘æ•°æ®å·²å¯¼å‡ºè‡³: {file_path}")
                self.status_var.set(f"è¯äº‘æ•°æ®å·²å¯¼å‡º: {os.path.basename(file_path)}")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯¼å‡ºè¯äº‘æ•°æ®æ—¶å‡ºé”™: {str(e)}")


if __name__ == "__main__":
    root = tk.Tk()
    app = TextAnalyzerApp(root)
    root.mainloop()