import pandas as pd
import matplotlib.pyplot as plt
from collections import Counter
import re
import os
import tkinter as tk
from tkinter import filedialog, ttk, messagebox, scrolledtext
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2Tk
from matplotlib.figure import Figure
import webbrowser
from datetime import datetime
import platform
import sys
import docx
from wordcloud import WordCloud
from PIL import Image, ImageTk
import numpy as np
from matplotlib import font_manager as fm
from matplotlib.offsetbox import AnnotationBbox, TextArea
import matplotlib.patheffects as path_effects

# è®¾ç½®ä¸­æ–‡æ˜¾ç¤º - ä¼˜åŒ–å­—ä½“æ£€æµ‹é€»è¾‘
plt.rcParams['axes.unicode_minus'] = False  # è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜


# å…¨å±€å­—ä½“è®¾ç½®
def setup_fonts():
    """è®¾ç½®å…¨å±€å­—ä½“"""
    # å°è¯•æŸ¥æ‰¾ç³»ç»Ÿä¸­æ–‡å­—ä½“
    chinese_fonts = []

    # Windowsç³»ç»Ÿ
    if platform.system() == "Windows":
        chinese_fonts = [
            "Microsoft YaHei", "SimHei", "SimSun", "KaiTi",
            "FangSong", "YouYuan", "STXihei", "STKaiti"
        ]

    # macOSç³»ç»Ÿ
    elif platform.system() == "Darwin":
        chinese_fonts = [
            "PingFang SC", "Heiti SC", "Hiragino Sans GB",
            "STHeiti", "Songti SC", "Kaiti SC"
        ]

    # Linuxç³»ç»Ÿ
    else:
        chinese_fonts = [
            "WenQuanYi Micro Hei", "Noto Sans CJK SC",
            "Source Han Sans CN", "AR PL UMing CN",
            "AR PL UKai CN"
        ]

    # æ£€æµ‹å¯ç”¨å­—ä½“
    available_fonts = []
    for font in chinese_fonts:
        try:
            # å°è¯•è®¾ç½®å­—ä½“
            plt.rcParams["font.family"] = font
            # æµ‹è¯•ç»˜åˆ¶
            fig, ax = plt.subplots(figsize=(1, 1))
            ax.text(0.5, 0.5, "æµ‹è¯•", fontsize=10)
            plt.close(fig)
            available_fonts.append(font)
        except:
            continue

    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ä¸­æ–‡å­—ä½“ï¼Œä½¿ç”¨é»˜è®¤å­—ä½“
    if not available_fonts:
        plt.rcParams["font.family"] = ["SimHei", "WenQuanYi Micro Hei", "Heiti TC"]
        return "SimHei"

    # è¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨çš„å­—ä½“
    return available_fonts[0]


# è®¾ç½®å…¨å±€å­—ä½“
global_font = setup_fonts()
print(f"å·²è®¾ç½®å…¨å±€å­—ä½“: {global_font}")


class TextAnalyzerApp:
    def __init__(self, root):
        self.root = root
        self.root.title("æ–‡æœ¬åˆ†æå·¥å…· v2.1")
        self.root.geometry("1081x843")
        self.root.resizable(True, True)

        # å¾®ä¿¡é£æ ¼é…è‰²æ–¹æ¡ˆ
        self.bg_color = "#f0f2f5"  # å¾®ä¿¡èƒŒæ™¯è‰²
        self.sidebar_color = "#ededed"  # ä¾§è¾¹æ èƒŒæ™¯è‰²
        self.header_color = "#07c160"  # å¾®ä¿¡ç»¿è‰²
        self.card_color = "#ffffff"  # å¡ç‰‡ç™½è‰²
        self.text_color = "#181818"  # ä¸»è¦æ–‡æœ¬é¢œè‰²
        self.secondary_text = "#7f7f7f"  # æ¬¡è¦æ–‡æœ¬é¢œè‰²
        self.highlight_color = "#129611"  # é«˜äº®ç»¿è‰²

        self.root.configure(bg=self.bg_color)

        # æ•°æ®ç›¸å…³å˜é‡
        self.file_path = None
        self.df = None
        self.selected_column = None
        self.word_freq = None
        self.stopwords = set(
            ['çš„', 'äº†', 'åœ¨', 'æ˜¯', 'æˆ‘', 'æœ‰', 'å’Œ', 'å°±', 'ä¸', 'äºº', 'éƒ½', 'ä¸€', 'ä¸€ä¸ª', 'ä¸Š', 'ä¹Ÿ', 'å¾ˆ', 'åˆ°',
             'è¯´', 'è¦', 'å»', 'ä½ ', 'ä¼š', 'ç€', 'æ²¡æœ‰', 'çœ‹', 'å¥½', 'è‡ªå·±', 'è¿™'])

        # å›¾è¡¨ç›¸å…³å˜é‡
        self.current_chart_type = "è¯äº‘å›¾"
        self.chart_canvas = None
        self.toolbar = None

        self.create_widgets()

    def create_widgets(self):
        # åˆ›å»ºä¸»æ¡†æ¶ - æ¨¡ä»¿å¾®ä¿¡å¸ƒå±€
        main_frame = tk.Frame(self.root, bg=self.bg_color)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        # å·¦ä¾§åŠŸèƒ½åŒºåŸŸ (1/4å®½åº¦)
        sidebar_frame = tk.Frame(main_frame, bg=self.sidebar_color, width=250)
        sidebar_frame.pack(side=tk.LEFT, fill=tk.Y, padx=(0, 10))

        # é¡¶éƒ¨æ ‡é¢˜
        header = tk.Frame(sidebar_frame, bg=self.header_color, height=50)
        header.pack(fill=tk.X)

        tk.Label(
            header,
            text="ğŸ“Š æ–‡æœ¬åˆ†æå·¥å…·",
            font=(global_font, 14, 'bold'),
            bg=self.header_color,
            fg='white',
            padx=15,
            pady=15
        ).pack(side=tk.LEFT)

        # åŠŸèƒ½å¡ç‰‡ - æ–‡ä»¶é€‰æ‹©
        file_card = tk.Frame(sidebar_frame, bg=self.card_color, padx=15, pady=15)
        file_card.pack(fill=tk.X, pady=10, padx=10)

        tk.Label(
            file_card,
            text="æ–‡ä»¶é€‰æ‹©",
            font=(global_font, 12, 'bold'),
            bg=self.card_color,
            fg=self.text_color
        ).pack(anchor=tk.W, pady=(0, 10))

        # æ–‡ä»¶ç±»å‹é€‰æ‹©å™¨
        type_frame = tk.Frame(file_card, bg=self.card_color)
        type_frame.pack(fill=tk.X, pady=5)

        self.file_type_var = tk.StringVar(value="all")
        types = [
            ("æ‰€æœ‰æ–‡ä»¶", "all"),
            ("Excel", "excel"),
            ("æ–‡æœ¬", "txt"),
            ("Word", "docx")
        ]

        for i, (text, value) in enumerate(types):
            btn = tk.Radiobutton(
                type_frame,
                text=text,
                variable=self.file_type_var,
                value=value,
                bg=self.card_color,
                fg=self.text_color,
                selectcolor=self.sidebar_color,
                font=(global_font, 10),
                indicatoron=0,
                width=6,
                bd=1,
                relief=tk.SOLID
            )
            btn.pack(side=tk.LEFT, padx=(0, 5) if i < len(types) - 1 else 0)

        # æ–‡ä»¶é€‰æ‹©æŒ‰é’®
        file_btn = tk.Button(
            file_card,
            text="ğŸ“ é€‰æ‹©æ–‡ä»¶",
            command=self.browse_file,
            bg=self.highlight_color,
            fg='white',
            font=(global_font, 11),
            bd=0,
            padx=10,
            pady=5
        )
        file_btn.pack(fill=tk.X, pady=10)

        self.file_path_var = tk.StringVar(value="æœªé€‰æ‹©æ–‡ä»¶")
        file_label = tk.Label(
            file_card,
            textvariable=self.file_path_var,
            bg=self.card_color,
            fg=self.secondary_text,
            font=(global_font, 9),
            wraplength=200,
            anchor=tk.W,
            justify=tk.LEFT
        )
        file_label.pack(fill=tk.X, pady=5)

        # åŠŸèƒ½å¡ç‰‡ - åˆ†æè®¾ç½®
        settings_card = tk.Frame(sidebar_frame, bg=self.card_color, padx=15, pady=15)
        settings_card.pack(fill=tk.X, pady=10, padx=10)

        tk.Label(
            settings_card,
            text="åˆ†æè®¾ç½®",
            font=(global_font, 12, 'bold'),
            bg=self.card_color,
            fg=self.text_color
        ).pack(anchor=tk.W, pady=(0, 10))

        # åˆ—é€‰æ‹©
        column_frame = tk.Frame(settings_card, bg=self.card_color)
        column_frame.pack(fill=tk.X, pady=5)

        tk.Label(
            column_frame,
            text="é€‰æ‹©åˆ—:",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10)
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.column_combo = ttk.Combobox(
            column_frame,
            state="disabled",
            width=15,
            font=(global_font, 10)
        )
        self.column_combo.pack(side=tk.LEFT, fill=tk.X, expand=True)
        self.column_combo.bind("<<ComboboxSelected>>", self.on_column_selected)

        # è¯è¯­æ•°é‡è®¾ç½®
        filter_frame = tk.Frame(settings_card, bg=self.card_color)
        filter_frame.pack(fill=tk.X, pady=10)

        tk.Label(
            filter_frame,
            text="æ˜¾ç¤ºè¯è¯­æ•°é‡:",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10)
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.filter_var = tk.IntVar(value=20)
        filter_scale = tk.Scale(
            filter_frame,
            from_=5,
            to=50,
            orient=tk.HORIZONTAL,
            variable=self.filter_var,
            bg=self.card_color,
            fg=self.text_color,
            highlightbackground=self.card_color,
            length=120,
            showvalue=0,
            sliderrelief=tk.FLAT,
            bd=0,
            command=self.on_filter_change
        )
        filter_scale.pack(side=tk.LEFT, fill=tk.X, expand=True)

        self.filter_label = tk.Label(
            filter_frame,
            textvariable=self.filter_var,
            bg=self.card_color,
            fg=self.highlight_color,
            font=(global_font, 10, 'bold'),
            width=3
        )
        self.filter_label.pack(side=tk.LEFT, padx=(5, 0))

        # åœç”¨è¯è®¾ç½®
        tk.Label(
            settings_card,
            text="åœç”¨è¯è®¾ç½®:",
            bg=self.card_color,
            fg=self.text_color,
            font=(global_font, 10)
        ).pack(anchor=tk.W, pady=(10, 5))

        self.stopwords_entry = tk.Entry(
            settings_card,
            font=(global_font, 10),
            bd=1,
            relief=tk.SOLID
        )
        self.stopwords_entry.pack(fill=tk.X, pady=5)
        self.stopwords_entry.insert(0, "çš„,äº†,åœ¨,æ˜¯,æˆ‘,æœ‰,å’Œ,å°±,ä¸,äºº")
        self.stopwords_entry.bind("<Return>", self.analyze_data)

        # åœç”¨è¯é¢„è®¾æŒ‰é’®
        preset_frame = tk.Frame(settings_card, bg=self.card_color)
        preset_frame.pack(fill=tk.X, pady=5)

        presets = [
            ("åŸºç¡€", "çš„,äº†,åœ¨,æ˜¯,æˆ‘,æœ‰,å’Œ,å°±,ä¸,äºº"),
            ("æ‰©å±•", "çš„,äº†,åœ¨,æ˜¯,æˆ‘,æœ‰,å’Œ,å°±,ä¸,äºº,éƒ½,ä¸€,ä¸€ä¸ª,ä¸Š,ä¹Ÿ,å¾ˆ,åˆ°,è¯´,è¦,å»,ä½ ,ä¼š,ç€,æ²¡æœ‰,çœ‹,å¥½,è‡ªå·±,è¿™"),
            ("æ¸…ç©º", "")
        ]

        for i, (text, value) in enumerate(presets):
            btn = tk.Button(
                preset_frame,
                text=text,
                command=lambda v=value: self.stopwords_entry.delete(0, tk.END) or self.stopwords_entry.insert(0, v),
                bg=self.sidebar_color,
                fg=self.text_color,
                font=(global_font, 9),
                bd=0,
                padx=8,
                pady=2
            )
            btn.pack(side=tk.LEFT, padx=(0, 5) if i < len(presets) - 1 else 0)

        # åˆ†ææŒ‰é’®
        analyze_btn = tk.Button(
            settings_card,
            text="ğŸ” å¼€å§‹åˆ†æ",
            command=self.analyze_data,
            bg=self.highlight_color,
            fg='white',
            font=(global_font, 11, 'bold'),
            bd=0,
            padx=10,
            pady=8
        )
        analyze_btn.pack(fill=tk.X, pady=10)

        # å³ä¾§ä¸»æ˜¾ç¤ºåŒºåŸŸ (3/4å®½åº¦)
        main_content = tk.Frame(main_frame, bg=self.bg_color)
        main_content.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)

        # å›¾è¡¨é€‰æ‹©å·¥å…·æ 
        toolbar = tk.Frame(main_content, bg=self.card_color, height=40)
        toolbar.pack(fill=tk.X, pady=(0, 5))

        # å›¾è¡¨ç±»å‹é€‰æ‹©
        self.chart_type = tk.StringVar(value="è¯äº‘å›¾")
        types = [("é¥¼çŠ¶å›¾", "é¥¼çŠ¶å›¾"), ("æŸ±çŠ¶å›¾", "æŸ±çŠ¶å›¾"), ("è¯äº‘å›¾", "è¯äº‘å›¾")]

        for i, (text, value) in enumerate(types):
            btn = tk.Radiobutton(
                toolbar,
                text=text,
                variable=self.chart_type,
                value=value,
                bg=self.card_color,
                fg=self.text_color,
                selectcolor=self.sidebar_color,
                font=(global_font, 10),
                indicatoron=0,
                width=8,
                bd=1,
                relief=tk.SOLID if self.chart_type.get() != value else tk.SUNKEN,
                command=self.update_chart_type
            )
            btn.pack(side=tk.LEFT, padx=(10, 0) if i == 0 else (0, 0), pady=5)

        # æ“ä½œæŒ‰é’®
        actions = [
            ("ğŸ”„ åˆ·æ–°", self.reset_view),
            ("ğŸ’¾ ä¿å­˜å›¾è¡¨", self.save_chart),
            ("ğŸ“ å¯¼å‡ºæ•°æ®", self.export_wordcloud)
        ]

        for text, command in actions:
            btn = tk.Button(
                toolbar,
                text=text,
                command=command,
                bg=self.card_color,
                fg=self.text_color,
                font=(global_font, 9),
                bd=1,
                relief=tk.GROOVE,
                padx=8,
                pady=2
            )
            btn.pack(side=tk.RIGHT, padx=5)

        # å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ (å æ®ä¸»è¦ç©ºé—´)
        self.chart_container = tk.Frame(main_content, bg='white', bd=1, relief=tk.SOLID)
        self.chart_container.pack(fill=tk.BOTH, expand=True)

        # åˆ›å»ºå›¾è¡¨å ä½ç¬¦
        self.chart_placeholder = tk.Label(
            self.chart_container,
            text="è¯·é€‰æ‹©æ–‡ä»¶å¹¶å¼€å§‹åˆ†æ",
            bg='white',
            fg=self.secondary_text,
            font=(global_font, 14),
            pady=100
        )
        self.chart_placeholder.pack(fill=tk.BOTH, expand=True)

        # æ•°æ®é¢„è§ˆåŒºåŸŸ
        preview_frame = tk.LabelFrame(
            main_content,
            text="æ•°æ®é¢„è§ˆ",
            bg=self.bg_color,
            fg=self.text_color,
            font=(global_font, 10, 'bold'),
            padx=10,
            pady=5,
            height=120  # å›ºå®šé«˜åº¦
        )
        preview_frame.pack(fill=tk.X, pady=(5, 0))
        preview_frame.pack_propagate(False)  # å›ºå®šé«˜åº¦

        # æ·»åŠ æ»šåŠ¨æ¡
        scroll_frame = tk.Frame(preview_frame, bg=self.bg_color)
        scroll_frame.pack(fill=tk.BOTH, expand=True)

        scrollbar = tk.Scrollbar(scroll_frame)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        self.preview_text = tk.Text(
            scroll_frame,
            height=5,  # å›ºå®š5è¡Œé«˜åº¦
            font=(global_font, 9),
            bg='white',
            fg=self.text_color,
            padx=10,
            pady=10,
            bd=1,
            relief=tk.SOLID,
            yscrollcommand=scrollbar.set
        )
        self.preview_text.pack(fill=tk.BOTH, expand=True)

        scrollbar.config(command=self.preview_text.yview)

        # çŠ¶æ€æ 
        status_frame = tk.Frame(self.root, bg=self.sidebar_color, height=24)
        status_frame.pack(fill=tk.X, side=tk.BOTTOM)

        self.status_var = tk.StringVar(value="å°±ç»ª")
        status_label = tk.Label(
            status_frame,
            textvariable=self.status_var,
            bg=self.sidebar_color,
            fg=self.secondary_text,
            font=(global_font, 9),
            anchor=tk.W,
            padx=10
        )
        status_label.pack(fill=tk.X)

    def update_chart_type(self, event=None):
        """æ›´æ–°å›¾è¡¨ç±»å‹å¹¶é‡æ–°ç»˜åˆ¶"""
        if self.word_freq is not None:
            self.current_chart_type = self.chart_type.get()
            self.show_chart()

    def on_filter_change(self, value):
        """è¿‡æ»¤æ¡ä»¶å˜åŒ–æ—¶æ›´æ–°å›¾è¡¨"""
        if self.word_freq is not None:
            self.root.after(300, self.show_chart)  # æ·»åŠ å»¶è¿Ÿé˜²æ­¢é¢‘ç¹åˆ·æ–°

    def browse_file(self):
        """æµè§ˆå¹¶é€‰æ‹©æ–‡ä»¶"""
        # æ ¹æ®é€‰æ‹©çš„æ–‡ä»¶ç±»å‹è®¾ç½®æ–‡ä»¶è¿‡æ»¤å™¨
        file_types = []
        file_type = self.file_type_var.get()

        if file_type == "all" or file_type == "excel":
            file_types.append(("Excelæ–‡ä»¶", "*.xlsx *.xls"))
        if file_type == "all" or file_type == "txt":
            file_types.append(("æ–‡æœ¬æ–‡ä»¶", "*.txt"))
        if file_type == "all" or file_type == "docx":
            file_types.append(("Wordæ–‡æ¡£", "*.docx"))

        file_path = filedialog.askopenfilename(
            title="é€‰æ‹©æ–‡ä»¶",
            filetypes=file_types
        )

        if file_path:
            self.file_path = file_path
            short_path = os.path.basename(file_path)
            self.file_path_var.set(f"å·²é€‰æ‹©: {short_path}")
            self.status_var.set(f"æ­£åœ¨åŠ è½½æ–‡ä»¶: {short_path}")
            self.root.after(100, self.load_file)

    def load_file(self):
        """åŠ è½½æ–‡ä»¶å†…å®¹"""
        try:
            if not self.file_path:
                return

            ext = os.path.splitext(self.file_path)[1].lower()

            if ext in ['.xlsx', '.xls']:
                # åŠ è½½Excelæ–‡ä»¶
                try:
                    self.df = pd.read_excel(self.file_path)
                except Exception as e:
                    # å°è¯•ä½¿ç”¨ä¸åŒçš„å¼•æ“åŠ è½½
                    if 'xlsx' in self.file_path:
                        self.df = pd.read_excel(self.file_path, engine='openpyxl')
                    else:
                        self.df = pd.read_excel(self.file_path)

                self.column_combo['values'] = list(self.df.columns)
                self.column_combo['state'] = "readonly"
                self.column_combo.current(0)
                self.selected_column = self.df.columns[0]

                # æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                self.show_data_preview()
                self.status_var.set(f"Excelæ–‡ä»¶åŠ è½½å®Œæˆï¼Œå…± {len(self.df)} è¡Œæ•°æ®")

            elif ext == '.txt':
                # åŠ è½½æ–‡æœ¬æ–‡ä»¶
                with open(self.file_path, 'r', encoding='utf-8') as f:
                    content = f.read()

                # åˆ›å»ºå•åˆ—DataFrame
                self.df = pd.DataFrame({f"æ–‡æœ¬å†…å®¹": [content]})
                self.column_combo['values'] = list(self.df.columns)
                self.column_combo['state'] = "readonly"
                self.column_combo.current(0)
                self.selected_column = self.df.columns[0]

                # æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                self.preview_text.delete(1.0, tk.END)
                preview = content[:500] + ('' if len(content) <= 500 else '...')
                self.preview_text.insert(tk.END, preview)
                self.status_var.set(f"æ–‡æœ¬æ–‡ä»¶åŠ è½½å®Œæˆï¼Œå…± {len(content)} ä¸ªå­—ç¬¦")

            elif ext == '.docx':
                # åŠ è½½Wordæ–‡æ¡£
                try:
                    doc = docx.Document(self.file_path)
                    content = "\n".join([para.text for para in doc.paragraphs if para.text.strip()])

                    # åˆ›å»ºå•åˆ—DataFrame
                    self.df = pd.DataFrame({f"æ–‡æ¡£å†…å®¹": [content]})
                    self.column_combo['values'] = list(self.df.columns)
                    self.column_combo['state'] = "readonly"
                    self.column_combo.current(0)
                    self.selected_column = self.df.columns[0]

                    # æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                    self.preview_text.delete(1.0, tk.END)
                    preview = content[:500] + ('' if len(content) <= 500 else '...')
                    self.preview_text.insert(tk.END, preview)
                    self.status_var.set(f"Wordæ–‡æ¡£åŠ è½½å®Œæˆï¼Œå…± {len(content)} ä¸ªå­—ç¬¦")

                except Exception as e:
                    messagebox.showerror("é”™è¯¯", f"è¯»å–Wordæ–‡æ¡£æ—¶å‡ºé”™: {str(e)}")
                    self.status_var.set("åŠ è½½æ–‡ä»¶å¤±è´¥")

            else:
                messagebox.showerror("é”™è¯¯", "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼")
                self.status_var.set("åŠ è½½æ–‡ä»¶å¤±è´¥")

        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"åŠ è½½æ–‡ä»¶æ—¶å‡ºé”™: {str(e)}")
            self.status_var.set("åŠ è½½æ–‡ä»¶å¤±è´¥")

    def show_data_preview(self):
        """æ˜¾ç¤ºæ•°æ®é¢„è§ˆ"""
        if self.df is not None:
            self.preview_text.delete(1.0, tk.END)
            preview = self.df.head().to_string(index=False)
            self.preview_text.insert(tk.END, preview)

    def on_column_selected(self, event=None):
        """åˆ—é€‰æ‹©äº‹ä»¶å¤„ç†"""
        self.selected_column = self.column_combo.get()
        self.status_var.set(f"å·²é€‰æ‹©åˆ—: {self.selected_column}")

    def analyze_data(self, event=None):
        """åˆ†ææ•°æ®"""
        if self.selected_column is None or self.df is None:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆé€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶å’Œåˆ—")
            return

        try:
            self.status_var.set("æ­£åœ¨åˆ†ææ•°æ®...")
            self.root.update()

            # è·å–é€‰å®šåˆ—çš„æ•°æ®
            column_data = self.df[self.selected_column].dropna()

            # åˆå¹¶æ‰€æœ‰æ–‡æœ¬
            all_text = ' '.join(column_data.astype(str))

            # å»é™¤æ ‡ç‚¹ç¬¦å·å’Œç‰¹æ®Šå­—ç¬¦
            cleaned_text = re.sub(r'[^\w\s]', '', all_text)

            # åˆ†å‰²æˆè¯è¯­
            words = cleaned_text.split()

            # æ›´æ–°åœç”¨è¯
            custom_stopwords = self.stopwords_entry.get().split(',')
            self.stopwords.update([word.strip() for word in custom_stopwords if word.strip()])

            # è¿‡æ»¤åœç”¨è¯
            filtered_words = [word for word in words if word not in self.stopwords]

            # ç»Ÿè®¡è¯é¢‘
            self.word_freq = Counter(filtered_words)

            # æ›´æ–°çŠ¶æ€
            total_words = len(filtered_words)
            unique_words = len(self.word_freq)
            self.status_var.set(f"åˆ†æå®Œæˆ: å…± {total_words} ä¸ªè¯è¯­ï¼Œ{unique_words} ä¸ªä¸åŒè¯è¯­")

            # æ˜¾ç¤ºå›¾è¡¨
            self.current_chart_type = self.chart_type.get()
            self.show_chart()

        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"åˆ†ææ•°æ®æ—¶å‡ºé”™: {str(e)}")
            self.status_var.set("åˆ†æå¤±è´¥")

    def create_pie_chart(self, ax, top_words, filter_count):
        """åˆ›å»ºé¥¼å›¾å¹¶è§£å†³å°æ ‡ç­¾é‡å é—®é¢˜"""
        labels, sizes = zip(*top_words)

        # è®¡ç®—æ€»è¯é¢‘
        total = sum(sizes)

        # ä¸ºå°æ‰‡åŒºåˆ›å»ºå¤–éƒ¨æ ‡ç­¾
        explode = [0.1 if size / total < 0.03 else 0 for size in sizes]
        wedges, texts, autotexts = ax.pie(
            sizes,
            labels=labels,
            autopct=lambda pct: f'{pct:.1f}%' if pct > 3 else '',
            startangle=90,
            textprops={'fontsize': 10},
            explode=explode,
            wedgeprops={'linewidth': 1, 'edgecolor': 'white'},
            pctdistance=0.85
        )

        # ä¸ºå°æ‰‡åŒºæ·»åŠ å¤–éƒ¨æ ‡ç­¾
        for i, (p, label) in enumerate(zip(wedges, labels)):
            if sizes[i] / total < 0.03:
                ang = (p.theta2 - p.theta1) / 2. + p.theta1
                y = np.sin(np.deg2rad(ang))
                x = np.cos(np.deg2rad(ang))

                # æ·»åŠ å¤–éƒ¨æ ‡ç­¾
                ax.annotate(
                    label,
                    xy=(x, y),
                    xytext=(1.35 * x, 1.35 * y),
                    arrowprops=dict(arrowstyle="-", color='gray', alpha=0.5),
                    ha='center' if x >= 0 else 'center',
                    va='center',
                    fontsize=9
                )

                # æ·»åŠ ç™¾åˆ†æ¯”æ ‡ç­¾
                ax.annotate(
                    f'{sizes[i] / total:.1%}',
                    xy=(x, y),
                    xytext=(1.15 * x, 1.15 * y),
                    ha='center' if x >= 0 else 'center',
                    va='center',
                    fontsize=8
                )

        ax.axis('equal')  # ä½¿é¥¼å›¾ä¸ºæ­£åœ†å½¢
        ax.set_title(f'è¯è¯­é¢‘ç‡åˆ†å¸ƒ (å‰{filter_count}ä¸ª)', fontsize=14)

    def create_bar_chart(self, ax, top_words, filter_count):
        """åˆ›å»ºæŸ±çŠ¶å›¾å¹¶è§£å†³æ ‡ç­¾é‡å é—®é¢˜"""
        labels, values = zip(*top_words)

        # åˆ›å»ºæŸ±çŠ¶å›¾
        bars = ax.bar(labels, values, color=self.header_color)
        ax.set_xlabel('è¯è¯­', fontsize=12)
        ax.set_ylabel('é¢‘ç‡', fontsize=12)
        ax.set_title(f'è¯è¯­é¢‘ç‡ç»Ÿè®¡ (å‰{filter_count}ä¸ª)', fontsize=14)

        # è®¾ç½®Xè½´æ ‡ç­¾
        ax.set_xticks(np.arange(len(labels)))
        ax.set_xticklabels(labels, rotation=45, ha='right', fontsize=9)

        # è‡ªåŠ¨è°ƒæ•´æ ‡ç­¾ä½ç½®é¿å…é‡å 
        plt.tight_layout()

        # æ·»åŠ æ•°å€¼æ ‡ç­¾
        for bar in bars:
            height = bar.get_height()
            ax.annotate(
                f'{height}',
                xy=(bar.get_x() + bar.get_width() / 2, height),
                xytext=(0, 3),  # 3ç‚¹å‚ç›´åç§»
                textcoords="offset points",
                ha='center',
                va='bottom',
                fontsize=9
            )

    def create_wordcloud(self, ax, top_words, filter_count):
        """åˆ›å»ºè¯äº‘å›¾"""
        # åˆ›å»ºè¯äº‘å¯¹è±¡
        wordcloud = WordCloud(
            font_path='simhei.ttf' if platform.system() == 'Windows' else None,
            width=1200,
            height=800,
            background_color='white',
            max_words=filter_count,
            colormap='viridis',
            collocations=False,  # ä¸åŒ…å«äºŒå…ƒç»„
            prefer_horizontal=0.9  # ä¼˜å…ˆæ°´å¹³æ’åˆ—
        ).generate_from_frequencies(dict(top_words))

        # æ˜¾ç¤ºè¯äº‘
        ax.imshow(wordcloud, interpolation='bilinear')
        ax.axis('off')
        ax.set_title(f'è¯è¯­äº‘å›¾ (å‰{filter_count}ä¸ª)', fontsize=14)

    def show_chart(self):
        """æ˜¾ç¤ºå›¾è¡¨"""
        if self.word_freq is None:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåˆ†ææ•°æ®")
            return

        try:
            # æ¸…é™¤å½“å‰å›¾è¡¨
            if hasattr(self, 'chart_placeholder'):
                self.chart_placeholder.destroy()
                del self.chart_placeholder

            # æ¸…é™¤ç°æœ‰å›¾è¡¨ç»„ä»¶
            if hasattr(self, 'toolbar') and self.toolbar:
                self.toolbar.destroy()
            if hasattr(self, 'chart_canvas') and self.chart_canvas:
                self.chart_canvas.get_tk_widget().destroy()

            # è·å–è¿‡æ»¤åçš„é«˜é¢‘è¯
            filter_count = self.filter_var.get()
            top_words = self.word_freq.most_common(filter_count)

            if not top_words:
                messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ç”Ÿæˆå›¾è¡¨")
                return

            # åˆ›å»ºå›¾è¡¨
            fig = Figure(figsize=(10, 8), dpi=100)
            ax = fig.add_subplot(111)

            # æ ¹æ®å½“å‰å›¾è¡¨ç±»å‹åˆ›å»ºå›¾è¡¨
            if self.current_chart_type == "é¥¼çŠ¶å›¾":
                self.create_pie_chart(ax, top_words, filter_count)
            elif self.current_chart_type == "æŸ±çŠ¶å›¾":
                self.create_bar_chart(ax, top_words, filter_count)
            elif self.current_chart_type == "è¯äº‘å›¾":
                self.create_wordcloud(ax, top_words, filter_count)

            # è®¾ç½®å…¨å±€å­—ä½“
            for text in ax.get_xticklabels() + ax.get_yticklabels():
                text.set_fontproperties(fm.FontProperties(family=global_font))

            ax.title.set_fontproperties(fm.FontProperties(family=global_font, size=14))
            ax.xaxis.label.set_fontproperties(fm.FontProperties(family=global_font, size=12))
            ax.yaxis.label.set_fontproperties(fm.FontProperties(family=global_font, size=12))

            # åœ¨Tkinterçª—å£ä¸­æ˜¾ç¤ºå›¾è¡¨
            self.chart_canvas = FigureCanvasTkAgg(fig, master=self.chart_container)
            self.chart_canvas.draw()
            self.chart_canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

            # æ·»åŠ å¯¼èˆªå·¥å…·æ 
            self.toolbar = NavigationToolbar2Tk(self.chart_canvas, self.chart_container)
            self.toolbar.update()
            self.chart_canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ç”Ÿæˆå›¾è¡¨æ—¶å‡ºé”™: {str(e)}")

    def reset_view(self):
        """é‡ç½®è§†å›¾"""
        if self.word_freq is not None:
            self.show_chart()

    def save_chart(self):
        """ä¿å­˜å½“å‰å›¾è¡¨"""
        if not hasattr(self, 'chart_canvas') or not hasattr(self.chart_canvas, 'figure'):
            messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰å¯ä¿å­˜çš„å›¾è¡¨")
            return

        try:
            default_filename = f"è¯è¯­åˆ†æå›¾è¡¨_{datetime.now().strftime('%Y%m%d_%H%M%S')}.png"
            file_path = filedialog.asksaveasfilename(
                title="ä¿å­˜å›¾è¡¨",
                defaultextension=".png",
                filetypes=[("PNGæ–‡ä»¶", "*.png"), ("JPGæ–‡ä»¶", "*.jpg"), ("SVGæ–‡ä»¶", "*.svg")],
                initialfile=default_filename
            )

            if file_path:
                self.chart_canvas.figure.savefig(file_path, dpi=300, bbox_inches='tight')
                messagebox.showinfo("æˆåŠŸ", f"å›¾è¡¨å·²ä¿å­˜è‡³: {file_path}")
                self.status_var.set(f"å›¾è¡¨å·²ä¿å­˜: {os.path.basename(file_path)}")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ä¿å­˜å›¾è¡¨æ—¶å‡ºé”™: {str(e)}")

    def export_wordcloud(self):
        """å¯¼å‡ºè¯äº‘æ•°æ®ä¸ºTXTæ–‡ä»¶"""
        if self.word_freq is None:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåˆ†ææ•°æ®")
            return

        try:
            # è·å–è¿‡æ»¤åçš„é«˜é¢‘è¯
            filter_count = self.filter_var.get()
            top_words = self.word_freq.most_common(filter_count)

            if not top_words:
                messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®å¯¼å‡º")
                return

            # åˆ›å»ºæ–‡æœ¬å†…å®¹
            content = "è¯è¯­\té¢‘ç‡\n" + "\n".join([f"{word}\t{count}" for word, count in top_words])

            # ä¿å­˜æ–‡ä»¶
            default_filename = f"è¯äº‘æ•°æ®_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
            file_path = filedialog.asksaveasfilename(
                title="å¯¼å‡ºè¯äº‘æ•°æ®",
                defaultextension=".txt",
                filetypes=[("æ–‡æœ¬æ–‡ä»¶", "*.txt")],
                initialfile=default_filename
            )

            if file_path:
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(content)

                messagebox.showinfo("æˆåŠŸ", f"è¯äº‘æ•°æ®å·²å¯¼å‡ºè‡³: {file_path}")
                self.status_var.set(f"è¯äº‘æ•°æ®å·²å¯¼å‡º: {os.path.basename(file_path)}")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯¼å‡ºè¯äº‘æ•°æ®æ—¶å‡ºé”™: {str(e)}")


if __name__ == "__main__":
    root = tk.Tk()
    app = TextAnalyzerApp(root)
    root.mainloop()